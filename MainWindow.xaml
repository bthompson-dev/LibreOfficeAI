<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="LibreOfficeAI.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:LibreOfficeAI"
    xmlns:models="using:LibreOfficeAI.Models"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Title="LibreOfficeAI">

    <Window.SystemBackdrop>
        <MicaBackdrop />
    </Window.SystemBackdrop>

    <Grid Background="#F2F6FA" x:Name="RootGrid">
        <!-- Top bar -->
        <Grid Margin="0,0,0,0" Height="80" VerticalAlignment="Top">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Top" Margin="24,24,0,0" Spacing="16">
                <!-- Settings Icon -->
                <Button Background="Transparent" BorderThickness="0">
                    <FontIcon Glyph="&#xE713;" />
                </Button>
                <!-- New Chat Icon -->
                <Button Background="Transparent" BorderThickness="0">
                    <FontIcon Glyph="&#xE932;" />
                </Button>
            </StackPanel>
            <!-- LibreOffice Logo Placeholder -->
            <Border Grid.Column="1" Margin="0,16,24,0" Padding="16,8" CornerRadius="16" Background="#F2F2F2" VerticalAlignment="Top">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <!-- Placeholder for logo icon -->
                    <Image Height="32">
                        <Image.Source>
                            <SvgImageSource UriSource="ms-appx:///Assets/LibreOffice_logo.svg"/>
                        </Image.Source>
                    </Image>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Chat area -->
        <Grid Margin="64,80,96,100">
            <Grid.Resources>
                <DataTemplate x:Key="UserMessageTemplate">
                    <Border Background="White" CornerRadius="16" Padding="16" HorizontalAlignment="Right" Margin="100,8,0,8" MaxWidth="400">
                        <TextBlock Text="{Binding Text}" TextWrapping="Wrap" FontSize="16" HorizontalAlignment="Right" IsTextSelectionEnabled="True" />
                    </Border>
                </DataTemplate>
                <DataTemplate x:Key="AIMessageTemplate">
                    <StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <ProgressRing IsActive="{Binding IsLoading}" Visibility="{Binding IsLoading}" HorizontalAlignment="Left" Margin="0,0,20,0" />
                            <Button IsEnabled="{Binding IsLoading}" Visibility="{Binding IsLoading}" Command="{Binding DataContext.CancelPromptCommand, ElementName=RootGrid}">Cancel request</Button>
                        </StackPanel>
                        <Border Background="#d9dbf5" CornerRadius="16" Padding="16" HorizontalAlignment="Left" Margin="0,8,100,8" 
                                Visibility="{Binding IsLoading, Converter={StaticResource BoolNegationConverter}}">
                            <TextBlock Text="{Binding Text}" HorizontalAlignment="Left" TextWrapping="Wrap" FontSize="16" IsTextSelectionEnabled="True" />
                        </Border>
                    </StackPanel>
                </DataTemplate>
                <DataTemplate x:Key="ErrorMessageTemplate">
                    <Border Background="red" CornerRadius="16" Padding="16" HorizontalAlignment="Left" Margin="0,8,100,8">
                        <TextBlock Text="{Binding Text}" HorizontalAlignment="Left" TextWrapping="Wrap" FontSize="16" IsTextSelectionEnabled="True" />
                    </Border>
                </DataTemplate>

                <models:MessageTemplateSelector x:Key="MessageTemplateSelector"
                                           UserTemplate="{StaticResource UserMessageTemplate}"
                                           AITemplate="{StaticResource AIMessageTemplate}"
                                           ErrorTemplate="{StaticResource ErrorMessageTemplate}"/>
            </Grid.Resources>
            <ScrollViewer x:Name="ChatScrollViewer"
                          Background="Transparent"
                          Padding="12,16"
                          ZoomMode="Disabled"
                          HorizontalScrollMode="Disabled"
                          HorizontalScrollBarVisibility="Disabled"
                          VerticalScrollBarVisibility="Auto">
                <ItemsRepeater x:Name="ChatItemsRepeater"
                               ItemsSource="{Binding ChatMessages}"
                               ItemTemplate="{StaticResource MessageTemplateSelector}">
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>

        <!-- Bottom input area -->
        <Grid VerticalAlignment="Bottom" Margin="0,0,0,32">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!--Input area-->
            <Grid Grid.Column="0" Margin="64,0,96,0">
                <TextBox
                    x:Name="PromptTextBox"
                    MinHeight="56"
                    MaxHeight="250"
                    FontSize="16"
                    Padding="28,15,56,15"
                    Background="White"
                    BorderBrush="#E0E0E0"
                    BorderThickness="1"
                    VerticalAlignment="Bottom"
                    CornerRadius="28"
                    VerticalContentAlignment="Center"
                    TextWrapping="Wrap"
                    Text="{Binding PromptText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    IsEnabled="{Binding AiTurn, Converter={StaticResource BoolNegationConverter}}"
                    KeyDown="PromptTextBox_KeyDown"
                    />
                <!-- Send button -->
                <Button
                    x:Name="SendButton"
                    Width="35"
                    Height="35"
                    Padding="0"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Right"
                    Margin="0,0,8,0"
                    Visibility="{Binding IsSendButtonVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                    Command="{Binding SendMessageCommand}"
                    Background="#4CAF50"
                    BorderThickness="0"
                    CornerRadius="20"
                    >
                    <FontIcon Glyph="&#xE724;" Foreground="White" FontSize="18" Margin="3,0,0,0"/>
                </Button>
            </Grid>
            <!-- Microphone Button -->
            <Button Width="56" Height="56" Background="White" BorderThickness="1" CornerRadius="28" Margin="-80,0,24,0" Grid.Column="1" VerticalAlignment="Bottom">
                <FontIcon Glyph="&#xE720;" />
            </Button>
        </Grid>
    </Grid>
</Window>